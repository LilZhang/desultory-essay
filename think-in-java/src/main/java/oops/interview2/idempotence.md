# 幂等性

## 什么是幂等性

- 任意多次执行所产生的影响与一次执行的影响相同
- 使用相同参数调用方法，获得相同结果，且不影响状态
- 注: 重复消息在 SOA 中相当常见


## 定义

- 一元运算: `f(f(x)) = f(x)` 中的 _f_ 为幂等
- 二元运算: `s * s = s` s 相对于 (*) 幂等
- 幂等元素: 被自己重复运算后仍等于自身的元素
- 乘法下的幂等实数: 0 和 1


## 非幂等 vs 幂等设计: 提现

- 非幂等需要分布式事务的解决方案

    1. 用户向服务器发起提现请求
    2. 提现成功返回 true, 失败返回 false

    缺点:

    1. 因响应缺失, 用户连续请求两次时, 会提现两次
    2. 正确运作需要分布式事务, 在各类异常时可 ROLLBACK


- 幂等设计摆脱分布式事务

    1. 用户为本次提现业务申请到一个业务流水号 bid (可用UUID实现)
    2. 用户向服务器发起提现请求, 并传入该业务流水号 bid
    3. 若提现记录表中不存在该提现记录, 则插入该记录, 返回'提现成功 for $bid'结果
    4. 上述操作可用 upsert 实现 (upsert 是一个幂等操作)

    5. 若提现记录表中已有该记录, 说明为重复提现, 无需操作, 返回之前的响应结果即可

此服务接口具有幂等性: 相同请求无论调用多少次都不影响系统状态


## HTTP 规范所定义的幂等性

1. GET 方法: 仅查询, 具有幂等性

注意: 不代表 GET 每次的查询结果相同, 仅表示不影响系统状态

2. PUT 方法: upsert 某条记录, 具有幂等性

3. DELETE 方法: 删除某条记录, 具有幂等性

4. POST 方法: 创建某条记录, _不_ 具有幂等性


## 什么是幂等操作

- 把编号为5的记录的A字段设置为0

这种操作不管执行多少次都是幂等的


- 把编号为5的记录的A字段增加1

这种操作显然就不是幂等的


## 分布式高并发系统如何保证对外接口的幂等性

从接口设计上来说不设计任何非幂等的操作即可。

譬如说需求是：
当用户点击提现时，将余额减少相应数量

改为：
当用户点击提现时，确保提现流水表中存在一条(且只有一条)对应的提现记录。
余额由提现流水表统计出来(可以有一定的计算冗余)。
