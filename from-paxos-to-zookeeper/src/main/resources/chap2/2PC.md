# 二阶段提交

## 所需节点

- Coordinator   协调节点
- Participant   参与节点

协调节点负责调度参与者的行为


## 二阶段提交步骤

参照一般事务的步骤

1. 开始事务
2. 执行 (同时记录 transaction log, undo, redo 之类)
3. 提交/回滚

### 阶段一 提交事务请求

1. 协调节点向所有参与节点发送事务内容, 请求参与节点执行, 并等待响应

2. 参与节点执行, 同时记录 transaction log (undo, redo), 返回执行结果(成功与否)


### 阶段二 执行事务提交

1. 协调节点会遇到三种情况:
    
    所有参与节点返回 执行成功 (succeed)
    有一个及以上节点返回 执行失败 (failed)
    有一个及以上节点返回超时 (timeout)
    
2. 若为执行成功, 协调节点请求参与节点对该事务进行提交
    若为执行失败与返回超时, 协调节点请求参与节点对该事物进行回滚
    
3. 参与节点执行完成之后向协调节点发送 acker, 协调节点收到后完成该次二阶段提交


## 二阶段提交缺点

1. 同步阻塞
    参与节点在等待其他协作者时无法处理其他工作
2. 协调节点的单点故障
3. 数据可能不一致
    发送提交事务请求这个操作是非原子性的
    若部分 COMMIT 请求在过程中丢失, 会造成部分事务提交而部分未提交
4. 太过保守