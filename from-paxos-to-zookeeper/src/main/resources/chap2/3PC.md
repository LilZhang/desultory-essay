# 三阶段提交

## 所需节点

- Coordinator   协调节点
- Participant   参与节点

协调节点负责调度参与者的行为


## 三阶段提交步骤

参照一般事务的步骤

1. 开始事务
2. 执行 (同时记录 transaction log, undo, redo 之类)
3. 提交/回滚

### 阶段一 canCommit

1. 协调节点向参与节点发送 canCommit 请求, 询问是否准备好开始事务
2. 参与节点可回复 yes 或 no 来表示是否准备好

### 阶段二 preCommit

1. 如果所有参与节点都准备好, 协调节点向参与节点发送 preCommit 请求
    若有参与节点没有准备好(返回 no 或者返回超时), 中断本次提交

2. 参与节点收到 preCommit 以后, 执行 (同时记录 transaction log, undo, redo 之类)

3. 参与节点向协调节点返回执行成功与否

### 阶段三 doCommit

1. 若协调节点收到的响应都为执行成功, 则向所有参与节点发送 doCommit 请求
    参与节点提交事务后, 返回 acker 给协调节点
    
2. 若协调节点收到的响应中有执行失败或超时, 则向所有参与节点发送回滚请求
    参与节点回滚事务后, 返回 acker 给协调节点
    

## 相对于 二阶段提交 的优点

- 据说能够缩小集群阻塞的范围(雾)


## 缺点

- 单点故障仍未解决
- 数据一致性仍未解决
